CREATE TABLE book(
	isbn VARCHAR(10) NOT NULL PRIMARY KEY,
	title TEXT NULL,
	amaz_rating DECIMAL(4,3) UNSIGNED NULL,
	pub_date VARCHAR(10) NULL,
	pages INT UNSIGNED NULL,
	small_url TEXT NULL,
	medium_url TEXT NULL,
	large_url TEXT NULL
	);
	
CREATE TABLE user(
	user_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	username VARCHAR(30) NOT NULL,
	password VARCHAR(30) NOT NULL,
	email VARCHAR(255) NULL,
	date_joined DATE NOT NULL
	);
	
CREATE TABLE lib_entry(
	lib_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	user_entry_id INT UNSIGNED NOT NULL,
	isbn VARCHAR(10) NOT NULL,
	user_rating DECIMAL(4,3) UNSIGNED NULL,
	date_added DATE NOT NULL,
	date_started DATE NULL,
	date_finished DATE NULL,
	FOREIGN KEY(isbn) REFERENCES book(isbn),
	FOREIGN KEY(user_entry_id) REFERENCES user(user_id)
	);
	
CREATE TABLE playlist_entry(
	playlist_id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
	entry_id INT UNSIGNED NOT NULL,
	user_id INT UNSIGNED NOT NULL,
	playlist_name VARCHAR(30),
	FOREIGN KEY(entry_id) REFERENCES lib_entry(lib_id),
	FOREIGN KEY(user_id) REFERENCES user(user_id)
	);
CREATE TABLE authors(
	isbn VARCHAR(10),
	author VARCHAR(255),
	FOREIGN KEY(isbn) REFERENCES book(isbn)
	);
CREATE TABLE tags(
	isbn VARCHAR(10),
	tag VARCHAR(255),
	FOREIGN KEY(isbn) REFERENCES book(isbn)
	);
CREATE TABLE alt_vers(
	isbn VARCHAR(10),
	alt_ver VARCHAR(10),
	FOREIGN KEY(isbn) REFERENCES book(isbn)
	);
CREATE TABLE carlweb(
	isbn VARCHAR(10) NOT NULL PRIMARY KEY,
	carlweb_id INT	NOT NULL,
	FOREIGN KEY(isbn) REFERENCES book(isbn)
	);
	
CREATE DEFINER=`root`@`localhost` PROCEDURE `insertAltVers`(isbn VARCHAR(10), altVers TEXT)
BEGIN
   DECLARE i INT;
   DECLARE temp TEXT;
   DECLARE done BOOLEAN;

   IF NOT altVers IS NULL THEN
      SET i = LOCATE(',',altVers)+1;
      SET temp = altVers;
      SET done = false;

      WHILE NOT done DO
         INSERT INTO alt_vers VALUES(null, isbn,SUBSTRING_INDEX(temp,',',1));
         SET i = LOCATE(',',temp)+1;
         IF i=1 THEN SET done = true; END IF;
         SET temp = SUBSTRING(temp, i);
      END WHILE;
   END IF;
END

CREATE DEFINER=`root`@`localhost` PROCEDURE `insertAuthors`(isbn VARCHAR(10), authors TEXT)
BEGIN
   DECLARE i INT;
   DECLARE temp TEXT;
   DECLARE done BOOLEAN;


   IF NOT authors IS NULL THEN
      SET i = LOCATE(',',authors)+1;
      SET temp = authors;
      SET done = false;


      WHILE NOT done DO
         INSERT INTO authors VALUES(null, isbn,SUBSTRING_INDEX(temp,',',1));
         SET i = LOCATE(',',temp)+1;
         IF i=1 THEN SET done = true; END IF;
         SET temp = SUBSTRING(temp, i);
      END WHILE;
   END IF;
END

CREATE DEFINER=`root`@`localhost` PROCEDURE `insertBook`(
        isbn VARCHAR(10), title TEXT, amaz_rating DECIMAL(4,3), pub_date VARCHAR(10),
        pages INTEGER, small_url TEXT, medium_url TEXT, large_url TEXT,
        authors TEXT, altVers TEXT, tags TEXT)
BEGIN
   INSERT INTO book VALUES(isbn, title, amaz_rating, pub_date, pages, small_url, medium_url, large_url);
   CALL insertAltVers(isbn, altVers);
   CALL insertAuthors(isbn, authors);
   CALL insertTags(isbn, tags);
END

CREATE DEFINER=`root`@`localhost` PROCEDURE `insertTags`(isbn VARCHAR(10), tags TEXT)
BEGIN
   DECLARE i INT;
   DECLARE temp TEXT;
   DECLARE done BOOLEAN;

   IF NOT tags IS NULL THEN
      SET i = LOCATE(',',tags)+1;
      SET temp = tags;
      SET done = false;

      WHILE NOT done DO
         INSERT INTO tags VALUES(null, isbn,SUBSTRING_INDEX(temp,',',1));
         SET i = LOCATE(',',temp)+1;
         IF i=1 THEN SET done = true; END IF;
         SET temp = SUBSTRING(temp, i);
         SELECT done;
     END WHILE;
   END IF;
END
